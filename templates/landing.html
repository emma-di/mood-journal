<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mood Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2&family=Quicksand&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script defer src="{{ url_for('static', filename='sky.js') }}"></script>
</head>

<body>
    <div class="sky">
        <div id="cloud-container"></div>

        {% if not username %}
            <!-- Show form if no name yet -->
            <form method="POST" class="name-form">
                <input type="text" name="username" placeholder="Enter your name" required />
                <button type="submit">Start</button>
            </form>
        {% else %}
            <!-- Show greeting and journal if name is set -->
            <div class="greeting">Welcome, {{ username }} ðŸŒ¸</div>

            <a href="{{ url_for('journal') }}">
                <img src="/static/assets/journal.png" class="floating-journal" alt = "Open Journal" />
            </a>

        {% endif %}
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;

            // Fetch sunrise/sunset times
            const res = await fetch(`https://api.sunrisesunset.io/json?lat=${lat}&lng=${lon}`);
            const data = await res.json();
            const now = new Date();
            const localTime = now.getHours() + now.getMinutes() / 60;

            const parseTime = (str) => {
                const [hourMin, period] = str.split(' ');
                let [h, m] = hourMin.split(':').map(Number);
                if (period === 'PM' && h < 12) h += 12;
                if (period === 'AM' && h === 12) h = 0;
                return h + m / 60;
            };

            const sunrise = parseTime(data.results.sunrise);
            const sunset = parseTime(data.results.sunset);

            const body = document.body;
            if (localTime < sunrise) {
                body.classList.add("bg-night");
            } else if (localTime < sunrise + 1.5) {
                body.classList.add("bg-dawn");
            } else if (localTime < sunset - 1.5) {
                body.classList.add("bg-day");
            } else if (localTime < sunset) {
                body.classList.add("bg-dusk");
            } else {
                body.classList.add("bg-night");
            }
        }, () => {
            // fallback if geolocation fails
            document.body.classList.add("bg-day");
        });
    });
    </script>
</body>
</html>